# Cloudflare Workers ビルド設定

## 重要な注意事項

Cloudflare Workersにデプロイする場合、**必ず `npm run build:cloudflare` を実行する必要があります**。

通常の `npm run build` では、`.vercel/output/static` ディレクトリが生成されないため、デプロイ時にエラーが発生します。

## Cloudflare Dashboardでの設定

Cloudflare Workersのダッシュボードで、以下の設定を行ってください：

### ビルド設定

- **Build command**: `npm run build:cloudflare`
- **Build output directory**: `.vercel/output/static`（または、`_worker.js`が存在する場合は`.vercel/output`）
- **Root directory**: `/` (プロジェクトルート)

### デプロイコマンド

**重要**: デプロイコマンドは**設定しないでください**（空のままにしてください）。

`wrangler.toml`の設定により、自動的にデプロイされます。

## 手動デプロイ

手動でデプロイする場合は、以下のコマンドを実行してください：

```bash
# 1. Cloudflare向けのビルド
npm run build:cloudflare

# 2. ビルド出力を確認
ls -la .vercel/output/

# 3. _worker.jsが存在するか確認
ls -la .vercel/output/_worker.js

# 4. デプロイ
npx wrangler deploy
```

## wrangler.tomlの設定

`wrangler.toml`の設定は、ビルド後の出力構造に応じて変更してください：

### _worker.jsが存在する場合

```toml
main = ".vercel/output/_worker.js"
assets = { directory = ".vercel/output/static" }
```

### _worker.jsが存在しない場合

```toml
assets = { directory = ".vercel/output/static" }
```

## トラブルシューティング

### エラー: The directory specified by the "assets.directory" field does not exist

このエラーが発生する場合、以下のいずれかが原因です：

1. **ビルドコマンドが間違っている**
   - `npm run build` ではなく `npm run build:cloudflare` を実行してください

2. **ビルドが失敗している**
   - ビルドログを確認し、エラーがないか確認してください

3. **ビルド出力ディレクトリが間違っている**
   - `.vercel/output/static` が存在するか確認してください

### 解決方法

1. Cloudflare Dashboardでビルドコマンドを `npm run build:cloudflare` に変更
2. ビルドを再実行
3. ビルドが成功したことを確認
4. デプロイを再実行

