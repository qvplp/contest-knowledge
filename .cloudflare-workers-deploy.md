# Cloudflare Workers デプロイ手順

## 前提条件

- Cloudflareアカウントが必要です
- Wrangler CLIがインストールされている必要があります（`npm install -g wrangler` または `npx wrangler` を使用）

## 重要な注意事項

⚠️ **`@cloudflare/next-on-pages`は主にCloudflare Pages向けです**

`@cloudflare/next-on-pages`は非推奨となっており、代わりに[OpenNextアダプター](https://opennext.js.org/cloudflare)の使用が推奨されています。

ただし、Next.js 16を使用している場合、`@cloudflare/next-on-pages`はNext.js 16を正式にサポートしていないため、`--legacy-peer-deps`フラグを使用してインストールする必要があります。

プロジェクトには`.npmrc`ファイルが含まれており、`legacy-peer-deps=true`が設定されているため、通常の`npm install`で問題なくインストールできます。

## デプロイ手順

### 1. 依存関係のインストール

```bash
npm install
```

**注意**: `.npmrc`ファイルに`legacy-peer-deps=true`が設定されているため、自動的に`--legacy-peer-deps`が適用されます。

### 2. Cloudflare向けのビルド

```bash
npm run build:cloudflare
```

このコマンドは `@cloudflare/next-on-pages` を使用して、Next.jsアプリをCloudflare向けにビルドします。

### 3. Workersとしてデプロイ

```bash
npm run deploy:cloudflare
```

または、個別に実行：

```bash
npm run build:cloudflare
npx wrangler deploy
```

## wrangler.toml の設定

`wrangler.toml`ファイルには以下の設定が含まれています：

```toml
name = "animehub-contest"
compatibility_date = "2025-12-15"
compatibility_flags = ["nodejs_compat"]
assets = { directory = ".vercel/output/static" }
```

### エントリーポイントについて

`@cloudflare/next-on-pages`が生成する出力構造によっては、`main`フィールドを追加する必要がある場合があります：

```toml
main = ".vercel/output/_worker.js"
```

ビルド後、`.vercel/output`ディレクトリの構造を確認し、適切なエントリーポイントを設定してください。

## トラブルシューティング

### エラー: Missing entry-point to Worker script

このエラーが発生する場合、以下のいずれかを試してください：

1. **assetsディレクトリを指定**（現在の設定）:
   ```toml
   assets = { directory = ".vercel/output/static" }
   ```

2. **mainエントリーポイントを指定**（_worker.jsが存在する場合）:
   ```toml
   main = ".vercel/output/_worker.js"
   ```

3. **両方を指定**:
   ```toml
   main = ".vercel/output/_worker.js"
   assets = { directory = ".vercel/output/static" }
   ```

### ビルドエラーが発生する場合

`@cloudflare/next-on-pages`はNext.js 16を正式にサポートしていないため、ビルドエラーが発生する可能性があります。

解決策：
- 依存関係の問題を解決する
- または、OpenNextアダプターへの移行を検討する

## 代替案: OpenNextアダプター

より安定したデプロイのため、OpenNextアダプターへの移行を検討してください：

1. `@opennextjs/cloudflare`をインストール
2. `next.config.ts`を更新
3. ビルドとデプロイスクリプトを更新

詳細は[OpenNext Cloudflare Documentation](https://opennext.js.org/cloudflare)を参照してください。

## 注意事項

- `location` オブジェクトはSSR環境では使用できません。`typeof window !== 'undefined' && window.location` のチェックが必要です。
- LocalStorageを使用している機能は、クライアントサイドでのみ動作します。
- `@cloudflare/next-on-pages`はNext.js 16を正式にサポートしていないため、`--legacy-peer-deps`を使用してインストールしています。

