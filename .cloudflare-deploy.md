# Cloudflare Pages デプロイ手順

## 前提条件

- Cloudflareアカウントが必要です
- Wrangler CLIがインストールされている必要があります（`npm install -g wrangler` または `npx wrangler` を使用）

## 重要な注意事項

⚠️ **`@cloudflare/next-on-pages`は非推奨です**

現在、`@cloudflare/next-on-pages`は非推奨となっており、代わりに[OpenNextアダプター](https://opennext.js.org/cloudflare)の使用が推奨されています。

ただし、Next.js 16を使用している場合、`@cloudflare/next-on-pages`はNext.js 16を正式にサポートしていないため、`--legacy-peer-deps`フラグを使用してインストールする必要があります。

プロジェクトには`.npmrc`ファイルが含まれており、`legacy-peer-deps=true`が設定されているため、通常の`npm install`で問題なくインストールできます。

## デプロイ手順

### 1. 依存関係のインストール

```bash
npm install
```

**注意**: `.npmrc`ファイルに`legacy-peer-deps=true`が設定されているため、自動的に`--legacy-peer-deps`が適用されます。

### 2. Cloudflare向けのビルド

```bash
npm run build:cloudflare
```

このコマンドは `@cloudflare/next-on-pages` を使用して、Next.jsアプリをCloudflare Pages向けにビルドします。

### 3. デプロイ

#### 方法1: Wrangler CLIを使用（推奨）

```bash
npx wrangler pages deploy .vercel/output/static
```

#### 方法2: Cloudflare Dashboardを使用

1. Cloudflare Dashboardにログイン
2. 「Workers & Pages」→「Pages」に移動
3. 「Create a project」をクリック
4. 「Upload assets」を選択
5. `.vercel/output/static` ディレクトリをアップロード

## ビルド設定（CI/CD）

Cloudflare Pagesのダッシュボードで以下の設定を行ってください：

### 必須設定

- **Build command**: `npm run build:cloudflare`
- **Build output directory**: `.vercel/output/static`
- **Root directory**: `/` (プロジェクトルート)

### デプロイコマンドについて

**重要**: **デプロイコマンドは設定しないでください**（空のままにしてください）。

Cloudflare Pagesは自動的にビルド出力をデプロイするため、デプロイコマンドは不要です。

もしデプロイコマンドが設定されている場合は、以下の手順で削除してください：

1. Cloudflare Dashboardにログイン
2. 「Workers & Pages」→「Pages」に移動
3. プロジェクトを選択
4. 「Settings」→「Builds & deployments」に移動
5. 「Deploy command」フィールドを**空にする**（削除する）

### エラーが発生する場合

もし`npx wrangler deploy`というエラーが表示される場合は、上記の手順でデプロイコマンドを削除してください。

手動でデプロイする場合は、以下のコマンドを使用してください：
```bash
npm run build:cloudflare
npx wrangler pages deploy .vercel/output/static
```

## 注意事項

- `location` オブジェクトはSSR環境では使用できません。`typeof window !== 'undefined' && window.location` のチェックが必要です。
- LocalStorageを使用している機能は、クライアントサイドでのみ動作します。
- `@cloudflare/next-on-pages`はNext.js 16を正式にサポートしていないため、`--legacy-peer-deps`を使用してインストールしています。
- 将来的には、OpenNextアダプターへの移行を検討することを推奨します。

## 将来の移行（OpenNextアダプター）

OpenNextアダプターへの移行を検討する場合は、以下のリソースを参照してください：

- [OpenNext Cloudflare Documentation](https://opennext.js.org/cloudflare)
- [OpenNext GitHub Repository](https://github.com/serverless-stack/open-next)

